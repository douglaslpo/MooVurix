version: '3.8'

services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: moodle_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: moodle
      POSTGRES_USER: moodleuser
      POSTGRES_PASSWORD: moodlepass123
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - moodle_db_data:/var/lib/postgresql/data
    ports:
      - "15432:5432"
    networks:
      - moodle_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U moodleuser -d moodle"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Moodle Application
  moodle:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: moodle_app
    restart: unless-stopped
    depends_on:
      - db
    environment:
      MOODLE_DATABASE_TYPE: pgsql
      MOODLE_DATABASE_HOST: db
      MOODLE_DATABASE_PORT_NUMBER: 5432
      MOODLE_DATABASE_NAME: moodle
      MOODLE_DATABASE_USER: moodleuser
      MOODLE_DATABASE_PASSWORD: moodlepass123
      MOODLE_SKIP_BOOTSTRAP: "no"
      MOODLE_SKIP_INSTALL: "no"
      MOODLE_USERNAME: admin
      MOODLE_PASSWORD: Admin@123
      MOODLE_EMAIL: admin@moodle.local
      MOODLE_SITE_NAME: "Moodle - Ambiente de Testes"
      MOODLE_LANG: pt_br
    volumes:
      - ./:/var/www/html
      - moodle_data:/var/moodledata
    ports:
      - "9080:80"
    networks:
      - moodle_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PHPMyAdmin para gerenciar o banco (opcional)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: moodle_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@moodle.local
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_LISTEN_PORT: 80
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - moodle_network
    depends_on:
      - db

volumes:
  moodle_db_data:
    driver: local
  moodle_data:
    driver: local
  pgadmin_data:
    driver: local

networks:
  moodle_network:
    driver: bridge

